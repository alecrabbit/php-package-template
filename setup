#!/usr/bin/env bash
# It's not a well written bash script but it works :)
for arg
do
    case "$arg" in
        --help)
            params+=("$arg")
            ;;
    esac
done

continue_setup=0

param_package_name="$1"
param_owner="$2"
param_owner_name="$3"
display_attention_message=0
do_add_origin=0
vcs_service="https://github.com/"

set -- "${params[@]}"  # overwrites the original positional params

cd bin
. imports.sh
cd ..

setup_help_message

user=$(whoami)
if [[ ${user} = "root" ]]
then
    light_yellow "Username: ${user}"
    error "DO NOT run this script under root!"
    exit 1
fi

set_title "ðŸ§° Setup script..."

green "ðŸ”§ Package template setup..."
dark "Version $(<bin/VERSION)"
current_dir="$(basename $(pwd))"
dark "Current dir: '${current_dir}'"
echo
if [[ -e "${COMPOSER_JSON_FILE}" ]]
then

    if [[ ! -z "$param_owner" ]]
    then
        display_attention_message=1
    fi

    yellow "Found '${COMPOSER_JSON_FILE}' file:"
    printf "${DARK}"
    cat "${COMPOSER_JSON_FILE}"
    printf "${NC}"

    package_owner=$(<${PKG_SETTINGS_DIR}/OWNER)
    package_owner_name=$(<${PKG_SETTINGS_DIR}/OWNER_NAME)
    package_name=$(<${PKG_SETTINGS_DIR}/NAME)
    package_description=$(<${PKG_SETTINGS_DIR}/DESCR)
    package_namespace=$(<${PKG_SETTINGS_DIR}/NMSPC)
    package_owner_namespace=$(<${PKG_SETTINGS_DIR}/OWNR_NMSPC)
    package_dir=$(<${PKG_SETTINGS_DIR}/PKGDIR)
    if [[ ${package_dir} == "" ]]
    then
        package_dir=$(enter_package_dir "${package_dir}" "${current_dir}")
        accepted_value "${package_dir}"
    fi

else
    package_description="Awesome library"
    prefix='php-'

    if [[ -e "${GLOBAL_DIST_DEFAULTS}" ]]
    then
        dark "Global settings found: ${GLOBAL_DIST_DEFAULTS}"

        source "${GLOBAL_DIST_DEFAULTS}"
        package_owner_name="${OWNER_NAME}"
        package_owner="${OWNER}"
        package_name="${PACKAGE_NAME}"
    else
        if [[ -e "${DIST_DEFAULTS}" ]]
        then
            source "${DIST_DEFAULTS}"
            package_owner_name="${OWNER_NAME}"
            package_owner="${OWNER}"
            package_name="${PACKAGE_NAME}"
        else
            package_owner_name="Mike Wazowski"
            package_owner="mike-wazowski"
            package_name="monsters-inc"
        fi
    fi
    # Ask owner name
    if [[ ! -z "$param_owner_name" ]]
    then
        package_owner_name="$param_owner_name"
    fi
    package_owner_name=$(read_value "package owner name" "Used in LICENSE file" "${package_owner_name}")
    package_owner_name=$(capitalize_every_word "${package_owner_name}")
    accepted_value "${package_owner_name}"
    # Ask owner
    if [[ ! -z "$param_owner" ]]
    then
        package_owner="$param_owner"
    fi
    package_owner=${package_owner,,}
    package_owner=$(read_value "package owner" "Used in composer.json line: \"name\": \"owner/name\")" "${package_owner}")
    package_owner=${package_owner// /}
    package_owner=${package_owner,,}
    accepted_value "${package_owner}"
    # Ask name
    if [[ ! -z "$param_package_name" ]]
    then
        package_name="$param_package_name"
    fi
    package_name=${package_name,,}
    package_name=$(read_value "package name" "" "${package_name}" "It should be unique among your packages!")
    package_name=${package_name// /}
    package_name=${package_name,,}
    accepted_value "${package_name}"
    # Ask description
    package_description=$(read_value "package description" "Used in composer.json line: \"description\": \"Your awesome description\"" "${package_description}")
    accepted_value "${package_description}"
    # Ask namespace
    if [[ ${package_name} == *"${prefix}"* ]]
    then
        package_namespace=${package_name#"$prefix"}
    else
        package_namespace="${package_name}"
    fi
    package_namespace="$(echo ${package_namespace//[-_]/ }| sed -r 's/\<./\U&/g')"
    package_namespace=${package_namespace// /}
    package_namespace=$(read_value "package namespace" "" "${package_namespace}")
    accepted_value "${package_namespace}"
    # Ask owner namespace
    yellow "Type 'y' to choose owner namespace otherwise no namespace will be used"
    read -p "Select namespace? " -n 1 -r -t 10
    if [[ $REPLY =~ ^[Yy]$ ]]
    then
        echo
        namespace=$(remove_symbols "${package_owner_name}")
        package_owner_namespace=$(select_owner_namespace "${namespace}")
    else
        package_owner_namespace=""
    fi
    accepted_value "${package_owner_namespace}"
    # Ask dir
    if [[ ${package_name} == *"${prefix}"* ]]
    then
        package_dir="${package_name}"
    else
        package_dir="${prefix}${package_name}"
    fi
    package_dir=$(enter_package_dir "${package_dir}" "${current_dir}")
    accepted_value "${package_dir}"

    # Creating setup
    yellow "Saving settings"

    mkdir ${PKG_SETTINGS_DIR}
    echo "${package_owner}" > ${PKG_SETTINGS_DIR}/OWNER
    echo "${package_owner_name}" > ${PKG_SETTINGS_DIR}/OWNER_NAME
    echo "${package_name}" > ${PKG_SETTINGS_DIR}/NAME
    echo "${package_description}" > ${PKG_SETTINGS_DIR}/DESCR
    echo "${package_namespace}" > ${PKG_SETTINGS_DIR}/NMSPC
    echo "${package_owner_namespace}" > ${PKG_SETTINGS_DIR}/OWNR_NMSPC
    echo "${package_dir}" > ${PKG_SETTINGS_DIR}/PKGDIR

    yellow "Creating ${COMPOSER_JSON_FILE}"
    if [[ ! ${package_owner_namespace} = "" ]]
    then
        separator='\\\\'
    else
        separator=''
    fi
    printf "${DARK}"
    sed "s/PACKAGE_OWNER/${package_owner}/g; s/PACKAGE_NAME/${package_name}/g; s/PACKAGE_DESCRIPTION/${package_description}/g; s/PACKAGE_NSPACE/${package_namespace}/g; s/PACKAGE_OWNR_NSPACE/${package_owner_namespace}${separator}/g;" ${COMPOSER_JSON_TEMPLATE} | tee "${COMPOSER_JSON_FILE}"
    printf "${NC}"

fi
green "Settings:"
if [[ ! ${package_owner_namespace} = "" ]]
then
     separator="\\"
else
     separator=""
fi
echo -e "Name: ${CYAN}${package_owner_name}${NC}"
echo -e "Package: ${CYAN}${package_owner}/${package_name}${NC}"
echo -e "Description: ${CYAN}${package_description}${NC}"
echo -e "Namespace: ${CYAN}${package_owner_namespace}${separator}${package_namespace}${NC}"
echo -e "Directory: ${CYAN}${package_dir}${NC}"
echo

check_if_dir_exists "../${package_dir}"
if [[ $? == 1 ]]
then
    error "Target dir '${package_dir}' is already taken."
    read -p "$(dark "Timeout 10 seconds...") Delete target directory and continue setup? " -n 1 -r -t 10
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]
    then
        green "Deleting"
        rm -rf "../${package_dir}"
        continue_setup=1
    else
        yellow "You should start over."
        echo "" > ${PKG_SETTINGS_DIR}/PKGDIR
        exit 1
    fi
fi

if [[ ${display_attention_message} -ne 0 ]]
then
    echo $(light_yellow "Attention!!!") $(yellow "Stored settings found!")
    echo $(red "Command arguments ignored!")
    echo $(dark "Remove stored settings before using arguments")
fi
if [[ ${continue_setup} -ne 1 ]]
then
    read -p "$(dark "Timeout 10 seconds...") Continue setup? " -n 1 -r -t 10
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]
    then
        continue_setup=1
    fi
fi
if [[ ${continue_setup} -ne 0 ]]
then
    set_title "ðŸ”§ Running setup script..."
    comment "ðŸš€ Setting up..."
    # Writing terminal title
    title="ðŸ“¦ ${package_name}"
    dark "Writing terminal title '${title}' to ${TERMINAL_TITLE_FILE} file"
    echo ${title} > ${TERMINAL_TITLE_FILE}
    dark "${TERMINAL_TITLE_FILE} contents:"
    cat ${TERMINAL_TITLE_FILE}

    yellow "Creating ${CHANGELOG_MD_FILE}"
    printf "${DARK}"
    sed "s/PACKAGE_OWNER/${package_owner}/g; s/PACKAGE_NAME/${package_name}/g;" ${CHANGELOG_MD_TEMPLATE} | tee "${CHANGELOG_MD_FILE}"
    printf "${NC}"
    yellow "Creating ${README_MD_FILE}"
    printf "${DARK}"
    sed "s/PACKAGE_OWNER/${package_owner}/g; s/PACKAGE_NAME/${package_name}/g; s/PACKAGE_DESCRIPTION/${package_description}/g;" ${README_MD_TEMPLATE} | tee "${README_MD_FILE}"
    printf "${NC}"

    u_id="$(id -u ${user})"
    g_id="$(id -g ${user})"
    if [[ -e "${ENV_FILE}" ]]
    then
        dark "Removing old .env file"
        rm .env
    fi
    green "Creating .env file"
    touch .env
    echo "USER_ID=${u_id}" >> .env
    echo "GROUP_ID=${u_id}" >> .env
    dark "Removing TODO.md"
    rm TODO.md
    green "Creating TODO.md"
    echo "- [x] add TODO.md file" >> TODO.md

    if [[ -e "${GIT_ATTR_FILE}" ]]
    then
        green "Creating .gitattributes file"
        mv ${GIT_ATTR_FILE} .gitattributes
    else
        if [[ -e ".gitattributes" ]]
        then
            dark ".gitattributes file already exists"
        else
            yellow ".gitattributes file not found"
        fi
    fi
    rm -rf .github/
    rm -rf "src"
    mkdir -p "src/$package_namespace"
    mkdir -p "tests/Feature"
    mkdir -p "tests/Unit"
    mkdir -p ".github"
    green "Writing 'composer.json'"
    mv "${COMPOSER_JSON_FILE}" composer.json
    green "Writing 'CHANGELOG.md'"
    mv "${CHANGELOG_MD_FILE}" CHANGELOG.md
    green "Writing 'README.md'"
    mv "${README_MD_FILE}" README.md

    rm LICENSE
    if [[ ! ${package_owner_namespace} = "" ]]
    then
         separator='\\'
    else
         separator=""
    fi

    rm  "tests/BasicTest.php"
    yellow "Creating ISSUE_TEMPLATE.md"
    printf "${DARK}"
    sed "s/PACKAGE_OWNER/${package_owner}/g;" template.ISSUE_TEMPLATE.md | tee ".github/ISSUE_TEMPLATE.md"
    printf "${NC}"
    yellow "Creating LICENSE"
    printf "${DARK}"
    sed "s/__YEAR/$(date +%Y)/g; s/PACKAGE_OWNER_NAME/${package_owner_name}/g;" template.LICENSE | tee LICENSE
    printf "${NC}"
    yellow "Creating BasicClass.php"
    printf "${DARK}"
    sed "s/PACKAGE_NSPACE/${package_owner_namespace}${separator}${package_namespace}/g;" template.BasicClass.php | tee "src/$package_namespace/BasicClass.php"
    printf "${NC}"
    yellow "Creating BasicTest.php"
    printf "${DARK}"
    sed "s/PACKAGE_NSPACE/${package_owner_namespace}${separator}${package_namespace}/g;" template.BasicTest.php | tee "tests/Unit/BasicTest.php"
    printf "${NC}"
    rm composer.lock
    rm example.composer.json
    rm ${DIST_ENV_FILE}
    rm template.*

    info "Stopping container if started"
    docker-compose down
    info "Renaming package dir"
    cd ..
    check_if_dir_exists "${package_dir}"
    if [[ $? == 1 ]]
    then
        error "Dir '${package_dir}' is already taken."
        comment "You should start over."
        dark "Cleaning up..."
        rm -rf "${current_dir}"
        exit 1
    fi
    mv -iT "${current_dir}" "${package_dir}"
    cd "${package_dir}"

    info "Starting container"
    docker-compose up -d
    info "Installing dependencies"
    docker-compose exec app composer install

    dark "Deleting old repository"
    rm -rf .git/

    dark "Deleting tmp setup dir ${PKG_SETTINGS_DIR}"
    rm -r ${PKG_SETTINGS_DIR}

    yellow "Deleting setup script"
    rm setup
    rm .defaults.dist

    green "Enhance '.gitignore'"
    echo '/bin/' >> .gitignore

    if [[ -x "$(command -v git)" ]]
    then
        green "Initializing new git repository"
        git init
        green "Adding files"
        git add --all --verbose
        info "Remote"
        add_origin "${package_owner}" "${package_name}" ${do_add_origin} ${vcs_service}

        check_git_user
        if [[ $? -ne 0 ]]
        then
            yellow "Can't commit: git user credentials not configured"
            dark "Assuming:"
            dark "'username@example.com' - your email"
            dark "'name' - your name"
            dark "Configure with:"
            dark "git config --global user.email username@example.com"
            dark "git config --global user.name name"
        else
            green "Committing files"
            git commit -m 'init'
            green "Git log:"
            git log --graph --oneline
        fi
    fi

    green "Run tests script"
    ./bin/tests --all

    info "Stopping container"
    docker-compose down
else
    echo "Setup skipped..."
    dark "To continue run setup script again and press 'y'"
    echo
    dark "To run fresh setup delete '${PKG_SETTINGS_DIR}' dir"
    dark "Command to use:"
    dark "rm -r ${PKG_SETTINGS_DIR}"
    echo
    set_title "$(pwd)"
    exit
fi
